---
import PageLayout from "../layouts/page.astro"
import { datoClient } from "../lib/api-client"
import EventListing from "../components/event-listing.astro"
import type { Event } from "../schema/event"

const now = new Date().toISOString()

const {
  data: { allEvents, _allEventsMeta },
} = await datoClient
  .post("", {
    json: {
      query: `{
        _allEventsMeta(filter: { start: { gte: "${now}" } }) {
          count
        }

        allEvents(filter: { start: { gte: "${now}" } }, orderBy: start_ASC, first: 100) {
          id
          title
          notes
          start
          end
          link
          fee
          isOnline
          mapLink
          eventType
          venueName
          streetAddress
          organiser {
            name
          }
          _status
          _firstPublishedAt
        }
      }`,
    },
  })
  .json<{
    data: { allEvents: Array<Event>; _allEventsMeta: { count: number } }
  }>()
---

<PageLayout title="BuildTechConnect">
  <header class="text-center flex flex-col gap-2 px-2">
    <h1 class="font-bold font-sans text-4xl antialiased text-textFg">
      Build<span class="text-sky-600">·</span>Tech<span class="text-sky-600"
        >·</span
      >Connect
    </h1>
    <p class="text text-slate-500">
      Upcoming events related to building and housing industry.
    </p>

    <p class="text-center text-slate-500">
      There {_allEventsMeta.count > 1 ? "are" : "is"}
      <span class="text-sky-600 text-2xl font-bold">{_allEventsMeta.count}</span
      >
      upcoming event{_allEventsMeta.count > 1 ? "s" : ""}.
    </p>
  </header>
  <ul role="list" class="flex flex-col gap-4 mt-4">
    {
      allEvents.map((event) => (
        <li>
          <EventListing event={event} />
        </li>
      ))
    }
  </ul>
</PageLayout>
